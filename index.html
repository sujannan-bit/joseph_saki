<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saki ç¾é£Ÿæ‰‹å¸³ | Foodie.AI</title>
    
    <!-- Supabase JavaScript SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        /* CSS è¦–è¦ºå±¤ - æ—¥ç³»æ¥µç°¡ç¾å­¸ */
        @import url('https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Serif+TC:wght@500;700&display=swap');

        :root {
            --bg-washi: #FDFCF8;
            --text-main: #4A3F35;
            --accent-blue: #7FB2BB;
            --border-color: #E6E2D8;
        }

        body { background: #F0F0F0; font-family: 'Noto Serif TC', serif; color: var(--text-main); margin: 0; }
        .app-container { width: 100%; max-width: 420px; margin: 0 auto; background: var(--bg-washi); min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

        nav { padding: 30px 20px 20px; border-bottom: 1px solid var(--border-color); text-align: center; }
        .logo { font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; }
        .subtitle { font-family: 'Klee One', cursive; font-size: 0.8rem; color: #999; margin-top: 5px; }

        .section-card { padding: 25px 20px; border-bottom: 1px solid var(--border-color); }
        .label { font-size: 0.85rem; font-weight: 700; margin-bottom: 15px; border-left: 3px solid var(--text-main); padding-left: 10px; }

        /* åˆ†é  Tabs */
        .tab-group { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .tab-btn { background: none; border: none; padding: 8px 5px; font-family: inherit; color: #ccc; cursor: pointer; }
        .tab-btn.active { color: var(--text-main); font-weight: 700; border-bottom: 2px solid var(--text-main); }

        /* è¼¸å…¥èˆ‡è¡¨å–® */
        .filter-row { display: flex; gap: 8px; margin-bottom: 15px; }
        select, .input-field { width: 100%; padding: 12px; border: 1px solid var(--border-color); background: #fff; outline: none; font-family: inherit; box-sizing: border-box; }
        .input-row-flex { display: flex; gap: 8px; margin-bottom: 10px; }
        .rating-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 0.85rem; }
        .rating-row input { width: 45px; }
        .note-textarea { height: 70px; resize: none; margin-top: 5px; font-family: 'Klee One', cursive; }

        .btn-save { width: 100%; padding: 12px; background: var(--text-main); color: #fff; border: none; cursor: pointer; border-radius: 4px; }
        .btn-cancel { width: 100%; background: none; border: none; color: #aaa; margin-top: 8px; cursor: pointer; font-size: 0.8rem; }

        /* åˆ—è¡¨æ¨£å¼ */
        .rest-item { padding: 15px 0; border-bottom: 1px dotted var(--border-color); display: flex; justify-content: space-between; align-items: flex-start; }
        .rest-info h4 { margin: 0 0 5px; font-size: 1rem; }
        .rest-info p { margin: 0; font-size: 0.75rem; color: #888; }
        .item-note { font-family: 'Klee One', cursive; color: #666; font-size: 0.8rem; margin-top: 8px !important; }

        /* åé£Ÿæ¨™ç±¤ */
        .picky-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .picky-tag { background: #eee; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-family: 'Klee One', cursive; cursor: pointer; }

        /* æ¬å®¶å€ */
        .sync-area { background: #f9f9f9; border: 1px dashed #ddd; margin: 20px; padding: 15px; text-align: center; }
        .sync-btns { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .sync-btns button { font-size: 0.75rem; padding: 8px; cursor: pointer; border: 1px solid #ccc; background: #fff; }

        .hidden { display: none !important; }
        #overlay { position: fixed; inset: 0; background: rgba(74, 63, 53, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-washi); width: 85%; max-width: 350px; padding: 30px; border-radius: 4px; text-align: center; }
        .spinner { border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid var(--text-main); border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        .sync-status { font-size: 0.75rem; color: #888; margin-top: 10px; }
    </style>
</head>
<body>

<div class="app-container">
    <nav>
        <div class="logo">Foodie.AI</div>
        <div class="subtitle">Saki ç¾é£Ÿè³‡æ–™åº« / é›²ç«¯åŒæ­¥ç‰ˆ</div>
        <div class="sync-status" id="sync-status">é€£æ¥ä¸­...</div>
        <div id="debug-log" style="position:fixed; bottom:0; right:0; width:350px; height:300px; background:#000; color:#0f0; font-family:monospace; font-size:0.65rem; overflow-y:auto; padding:10px; border:1px solid #0f0; display:none; z-index:1000; box-shadow:0 0 10px rgba(0,0,0,0.8); border-radius:4px 4px 0 0; margin:10px;">
            <div style="margin-bottom:5px; padding-bottom:5px; border-bottom:1px solid #0f0; font-weight:bold;">ğŸ”§ è¨ºæ–·çª—å£ (æŒ‰ Ctrl+Shift+T é—œé–‰)</div>
            <div id="debug-content"></div>
        </div>
    </nav>

    <main>
        <section class="section-card">
            <div class="label">âœ¨ Gemini æ™ºæ…§æœå°‹ / AI æ¤œç´¢</div>
            <div class="filter-row">
                <input type="text" id="ai-command" placeholder="æƒ³åƒé»ä»€éº¼ï¼Ÿ" class="input-field" style="flex:1">
                <button onclick="startGeminiSearch()" style="padding:0 15px; background:var(--text-main); color:white; border:none; border-radius:4px; cursor:pointer;">Ask</button>
            </div>
        </section>

        <section class="section-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="label" style="margin:0">ğŸ“¦ é¤å»³æ¸…å–® / ãƒªã‚¹ãƒˆ</div>
                <button onclick="toggleForm()" style="background:none; border:1px solid #ddd; padding:5px 10px; cursor:pointer; color:#888; border-radius:4px;">ï¼‹ æ–°å¢</button>
            </div>

            <div class="tab-group">
                <button class="tab-btn active" onclick="setTab('all', this)">å…¨éƒ¨</button>
                <button class="tab-btn" onclick="setTab('wish', this)">æƒ³å»æ¸…å–®</button>
                <button class="tab-btn" onclick="setTab('high', this)">é«˜åˆ† (4â˜…+)</button>
            </div>

            <div class="filter-row">
                <select id="loc-filter" onchange="renderRests()">
                    <option value="all">æ‰€æœ‰å€åŸŸ</option>
                    <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                    <option value="æ°‘é›„é„‰">æ°‘é›„é„‰</option>
                    <option value="ä¸­æ­£å¤§å­¸é™„è¿‘">ä¸­æ­£å¤§å­¸é™„è¿‘</option>
                </select>
                <select id="style-filter" onchange="renderRests()">
                    <option value="all">æ‰€æœ‰é¡åˆ¥</option>
                    <option value="ä¸­å¼">ä¸­å¼</option>
                    <option value="æ—¥å¼">æ—¥å¼</option>
                    <option value="éŸ“å¼">éŸ“å¼</option>
                    <option value="è¥¿å¼">è¥¿å¼</option>
                    <option value="ç”œé»/é£²æ–™">ç”œé»/é£²æ–™</option>
                </select>
            </div>

            <div id="add-form" class="hidden" style="background:#fff; padding:15px; border:1px solid var(--border-color); margin-bottom:20px; border-radius:4px;">
                <input type="hidden" id="edit-id">
                <input type="text" id="restName" placeholder="åº—å" class="input-field" style="margin-bottom:10px;">
                <input type="text" id="restMap" placeholder="Google Map é€£çµ" class="input-field" style="margin-bottom:10px;">
                <div class="input-row-flex">
                    <select id="addLoc" class="input-field">
                        <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                        <option value="æ°‘é›„é„‰">æ°‘é›„é„‰</option>
                        <option value="ä¸­æ­£å¤§å­¸é™„è¿‘">ä¸­æ­£å¤§å­¸é™„è¿‘</option>
                    </select>
                    <select id="addStyle" class="input-field">
                        <option value="ä¸­å¼">ä¸­å¼</option>
                        <option value="æ—¥å¼">æ—¥å¼</option>
                        <option value="éŸ“å¼">éŸ“å¼</option>
                        <option value="è¥¿å¼">è¥¿å¼</option>
                        <option value="ç”œé»/é£²æ–™">ç”œé»/é£²æ–™</option>
                    </select>
                </div>
                <div class="rating-row">
                    <span>ğŸ° å’ª: <input type="number" id="janeScore" min="0" max="5" value="5"></span>
                    <span>ğŸ§” è˜‡: <input type="number" id="suScore" min="0" max="5" value="5"></span>
                </div>
                <textarea id="restNote" placeholder="å¿…é»èœè‰²æˆ–å¿ƒå¾—..." class="input-field note-textarea"></textarea>
                <button class="btn-save" onclick="saveRest()">ğŸ”’ é–å®šå­˜å…¥ / ä¿å­˜</button>
                <button class="btn-cancel" onclick="toggleForm()">å–æ¶ˆ</button>
            </div>

            <div id="rest-list"></div>
        </section>

        <section class="section-card">
            <div class="label">âœ Saki åé£Ÿæ‰‹å¸³ (é»æ“Šå¯ç·¨è¼¯)</div>
            <div class="filter-row">
                <input type="text" id="picky-input" placeholder="æˆ‘ä¸åƒ..." class="input-field" style="flex:1">
                <button onclick="addPicky()" style="padding:0 15px; background:none; border:1px solid #ddd; cursor:pointer; border-radius:4px;">ç´€éŒ„</button>
            </div>
            <div id="picky-tags" class="picky-tags"></div>
        </section>

        <div class="sync-area">
            <div style="font-size:0.8rem; font-weight:bold; color:#666;">ğŸ”„ è¨­å‚™åŒæ­¥ (è‡ªå‹•é›²ç«¯åŒæ­¥)</div>
            <div class="sync-btns">
                <button onclick="exportData()">è¤‡è£½å‚™ä»½ä»£ç¢¼</button>
                <button onclick="importData()">åŒ¯å…¥ä»£ç¢¼</button>
            </div>
        </div>
    </main>

    <div id="overlay" class="hidden" onclick="closeOverlay()">
        <div class="modal" onclick="event.stopPropagation()">
            <div id="ai-loading"><div class="spinner"></div><p>Gemini åˆ†æä¸­...</p></div>
            <div id="ai-result-content" class="hidden">
                <h2 id="res-name"></h2>
                <div id="res-info" style="margin:10px 0; font-size:0.9rem; color:#888;"></div>
                <div id="res-score" style="margin:10px 0; color:var(--accent-blue); font-weight:bold;"></div>
                <p id="res-note" style="font-family:'Klee One'; color:#666; font-size:0.9rem;"></p>
                <a id="res-map" href="#" target="_blank" style="display:block; margin:20px 0; padding:12px; background:var(--accent-blue); color:white; text-decoration:none; border-radius:4px; font-weight:bold;">ğŸ“ é–‹å•Ÿåœ°åœ–å°èˆª</a>
                <button onclick="closeOverlay()" style="border:none; background:none; color:#999; cursor:pointer; font-size:0.8rem;">é—œé–‰ / Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // âš™ï¸ Supabase é…ç½®ï¼ˆå…¨å±€ä½œç”¨åŸŸï¼‰
    window.SUPABASE_URL = "https://febybjerrksqgqffjcfj.supabase.co";
    window.SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZlYnliamVycmtzcWdxZmZqY2ZqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg0ODQ5NzAsImV4cCI6MjA4NDA2MDk3MH0.IAZ8ZHmLtQVX2n91sEdUCyOWEAtdzFxZCaIE31CmUmA";
</script>

<script>
    // ğŸ”§ å…¨å±€è®Šé‡
    // å‘å¾Œå…¼å®¹ï¼šæœ‰äº›éƒ¨ç½²å¯èƒ½ç›´æ¥ä½¿ç”¨ `SUPABASE_URL` / `SUPABASE_KEY`
    // å› æ­¤åœ¨å…¨å±€ scope åŒæ™‚è¨­ç½®è®Šæ•¸å’Œ window å±¬æ€§
    var SUPABASE_URL = window.SUPABASE_URL || '';
    var SUPABASE_KEY = window.SUPABASE_KEY || '';
    var rests = [];
    var picky = [];
    var currentTab = 'all';
    var supabase = null;
    var isInitialized = false;
    var userId = null;
    var debugLogs = [];
    
    function addDebugLog(msg) {
        debugLogs.push('[' + new Date().toLocaleTimeString('zh-TW') + '] ' + msg);
        const content = document.getElementById('debug-content');
        if(content) {
            content.innerHTML = debugLogs.map(l => '<div>' + l + '</div>').join('');
            content.parentElement.scrollTop = content.parentElement.scrollHeight;
        }
    }
    
    function toggleDebug() {
        const debug = document.getElementById('debug-log');
        debug.style.display = debug.style.display === 'none' ? 'block' : 'none';
    }
    
    // å¿«æ·é”®ï¼šCTRL+SHIFT+T æ‰“å¼€è¯Šæ–­çª—å£
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey && e.shiftKey && e.code === 'KeyT') {
            e.preventDefault();
            toggleDebug();
        }
    });
    
    // ============================================================================
    // â˜ï¸ Supabase é›²ç«¯åŒæ­¥æ ¸å¿ƒå‡½æ•¸
    // ============================================================================
    
    document.addEventListener('DOMContentLoaded', async () => {
        console.log('ğŸš€ åº”ç”¨å¯åŠ¨...');
        await initSupabase();
    });

    async function initSupabase() {
        try {
            console.log('ğŸ“¡ æ£€æŸ¥ Supabase é…ç½®...');
            addDebugLog('ğŸ“¡ æ£€æŸ¥ Supabase é…ç½®...');
            
            // æ£€æŸ¥é…ç½®æœ‰æ•ˆæ€§
            if (!window.SUPABASE_URL || !window.SUPABASE_KEY || !window.SUPABASE_URL.includes('supabase.co')) {
                throw new Error('Supabase é…ç½®æ— æ•ˆ');
            }
            
            addDebugLog('âœ… é…ç½®æœ‰æ•ˆ');
            
            // æ£€æŸ¥ SDK æ˜¯å¦åŠ è½½
            if (!window.supabase) {
                throw new Error('Supabase SDK æœªåŠ è½½');
            }
            
            console.log('âœ… SDK å·²åŠ è½½ï¼Œåˆå§‹åŒ–å®¢æˆ·ç«¯...');
            addDebugLog('âœ… SDK å·²åŠ è½½ï¼Œåˆå§‹åŒ–å®¢æˆ·ç«¯...');
            
            // åˆå§‹åŒ– Supabase å®¢æˆ·ç«¯
            supabase = window.supabase.createClient(window.SUPABASE_URL, window.SUPABASE_KEY);
            
            console.log('âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ');
            addDebugLog('âœ… å®¢æˆ·ç«¯åˆå§‹åŒ–å®Œæˆ');
            
            // ç”Ÿæˆè£…ç½® ID
            userId = localStorage.getItem('SAKI_USER_ID');
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('SAKI_USER_ID', userId);
                console.log('ğŸ“± ç”Ÿæˆæ–°è£…ç½® ID:', userId);
            }
            
            // è½½å…¥æœ¬åœ°æ•°æ®
            console.log('ğŸ’¾ è½½å…¥æœ¬åœ°æ•°æ®...');
            addDebugLog('ğŸ’¾ è½½å…¥æœ¬åœ°æ•°æ®...');
            loadLocalData();
            renderRests();
            renderPicky();
            
            // åŒæ­¥äº‘ç«¯æ•°æ®
            console.log('â˜ï¸ åŒæ­¥äº‘ç«¯æ•°æ®...');
            addDebugLog('â˜ï¸ åŒæ­¥äº‘ç«¯æ•°æ®...');
            await syncFromSupabase();
            
            // è®¾ç½®å®šæœŸè½®è¯¢ï¼ˆä¸ä½¿ç”¨ä¸ç¨³å®šçš„å®æ—¶è®¢é˜…ï¼‰
            console.log('ğŸ”„ å¯åŠ¨å®šæœŸè½®è¯¢ï¼ˆæ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰...');
            addDebugLog('ğŸ”„ å¯åŠ¨å®šæœŸè½®è¯¢ï¼ˆæ¯ 10 ç§’æ£€æŸ¥ä¸€æ¬¡ï¼‰...');
            setInterval(syncFromSupabase, 10000);
            
            isInitialized = true;
            updateSyncStatus('connected');
            addDebugLog('âœ… Supabase åˆå§‹åŒ–æˆåŠŸï¼');
            console.log('âœ… Supabase åˆå§‹åŒ–æˆåŠŸï¼');
            
        } catch(e) {
            addDebugLog('âŒ é”™è¯¯: ' + e.message);
            console.error('âŒ Supabase åˆå§‹åŒ–å¤±è´¥:', e.message);
            console.error('è¯¦ç»†ä¿¡æ¯:', e);
            
            // ä½¿ç”¨æœ¬åœ°æ•°æ®æ¨¡å¼
            loadLocalData();
            renderRests();
            renderPicky();
            updateSyncStatus('offline');
            isInitialized = true;
            addDebugLog('ğŸ’¾ å·²åˆ‡æ¢åˆ°æœ¬åœ°æ•°æ®æ¨¡å¼');
            console.log('ğŸ’¾ å·²åˆ‡æ¢åˆ°æœ¬åœ°æ•°æ®æ¨¡å¼');
        }
    }

    async function syncFromSupabase() {
        if (!supabase) {
            console.log('âš ï¸ Supabase å®¢æˆ·ç«¯æœªåˆå§‹åŒ–');
            return;
        }
        
        try {
            console.log('ğŸ”„ æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...');
            
            // æ·»åŠ  5 ç§’è¶…æ—¶
            const syncPromise = supabase
                .from('restaurant_data')
                .select('*')
                .order('timestamp', { ascending: false })
                .limit(1);
            
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('åŒæ­¥è¶…æ—¶')), 5000)
            );
            
            const result = await Promise.race([syncPromise, timeoutPromise]);
            const { data: restsData, error: restsError } = result;
            
            if (restsError) throw restsError;
            
            if (restsData && restsData.length > 0) {
                const latestData = restsData[0];
                const newRests = latestData.rests || [];
                const newPicky = latestData.picky || [];
                
                // åªæœ‰æ•°æ®æœ‰å˜åŒ–æ‰æ›´æ–°
                if (JSON.stringify(newRests) !== JSON.stringify(rests)) {
                    console.log('ğŸ“¥ æ”¶åˆ°æ–°çš„é¤å…æ•°æ®');
                    rests = newRests;
                    renderRests();
                }
                
                if (JSON.stringify(newPicky) !== JSON.stringify(picky)) {
                    console.log('ğŸ“¥ æ”¶åˆ°æ–°çš„åé£Ÿæ•°æ®');
                    picky = newPicky;
                    renderPicky();
                }
                
                saveLocalData();
            } else {
                console.log('ğŸ“­ äº‘ç«¯æš‚æ— æ•°æ®');
            }
            
            updateSyncStatus('connected');
        } catch(e) {
            console.warn('âš ï¸ åŒæ­¥å‡ºé”™:', e.message);
            // ä¸æ”¹å˜çŠ¶æ€ï¼Œç»§ç»­å°è¯•
        }
    }

async function saveToSupabase() {
        if (!supabase || !isInitialized) {
            console.log('ğŸ’¾ ç¦»çº¿æ¨¡å¼ï¼šä¿å­˜åˆ°æœ¬åœ°');
            saveLocalData();
            return;
        }
        
        try {
            const dataToSave = {
                user_id: userId,
                rests: rests,
                picky: picky,
                timestamp: new Date().toISOString(),
                device_info: navigator.userAgent
            };
            
            console.log('â˜ï¸ ä¸Šä¼ æ•°æ®åˆ° Supabase...');
            
            // æ·»åŠ è¶…æ—¶
            const savePromise = supabase
                .from('restaurant_data')
                .insert([dataToSave], { returning: 'minimal' });
            
            const timeoutPromise = new Promise((_, reject) => 
                setTimeout(() => reject(new Error('ä¸Šä¼ è¶…æ—¶')), 5000)
            );
            
            const result = await Promise.race([savePromise, timeoutPromise]);
            const { error } = result;
            
            if (error) throw error;
            
            saveLocalData();
            console.log('âœ… æ•°æ®å·²ä¸Šä¼ ');
            updateSyncStatus('connected');
        } catch(e) {
            console.warn('âš ï¸ ä¸Šä¼ å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°:', e.message);
            saveLocalData();
            updateSyncStatus('offline');
        }
    }

    // ============================================================================
    // ğŸ’¾ æœ¬åœ°å­˜å„²å‡½æ•¸
    // ============================================================================

    function loadLocalData() {
        try {
            const localRests = localStorage.getItem('SAKI_RESTS');
            const localPicky = localStorage.getItem('SAKI_PICKY');
            if (localRests) rests = JSON.parse(localRests);
            if (localPicky) picky = JSON.parse(localPicky);
        } catch(e) {
            console.log('âš ï¸ æœ¬åœ°æ•¸æ“šè¼‰å…¥å¤±æ•—');
        }
    }

    function saveLocalData() {
        try {
            localStorage.setItem('SAKI_RESTS', JSON.stringify(rests));
            localStorage.setItem('SAKI_PICKY', JSON.stringify(picky));
        } catch(e) {
            console.log('âš ï¸ æœ¬åœ°å­˜å„²å¤±æ•—');
        }
    }

    function updateSyncStatus(state) {
        const status = document.getElementById('sync-status');
        if (state === 'connected') {
            status.innerText = 'âœ“ é›²ç«¯å·²é€£æ¥ (' + new Date().toLocaleTimeString('zh-TW') + ')';
            status.style.color = '#7FB2BB';
        } else if (state === 'offline') {
            status.innerText = 'ğŸ’¾ æœ¬æ©Ÿæ¨¡å¼ (Supabase æœªè¨­ç½®)';
            status.style.color = '#d4622f';
        } else if (state === 'error') {
            status.innerText = 'âš  åŒæ­¥å‡ºéŒ¯ (ä½¿ç”¨æœ¬åœ°)';
            status.style.color = '#e67e22';
        }
    }

    // ============================================================================
    // ğŸ“¦ é¤å»³ç®¡ç† (CRUD æ“ä½œ)
    // ============================================================================

    async function saveRest() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('restName').value;
        if(!name) return alert('åº—åæ˜¯å¿…å¡«çš„å–”ï¼');

        const newRest = {
            id: id ? parseInt(id) : Date.now(),
            name: name,
            map: document.getElementById('restMap').value,
            loc: document.getElementById('addLoc').value,
            style: document.getElementById('addStyle').value,
            jane: parseInt(document.getElementById('janeScore').value),
            su: parseInt(document.getElementById('suScore').value),
            note: document.getElementById('restNote').value
        };

        if(id) {
            const idx = rests.findIndex(r => r.id == id);
            if(idx >= 0) rests[idx] = newRest;
        } else {
            rests.push(newRest);
        }
        
        await saveToSupabase();
        renderRests();
        toggleForm();
    }

    function renderRests() {
        const locF = document.getElementById('loc-filter').value;
        const styleF = document.getElementById('style-filter').value;
        const container = document.getElementById('rest-list');

        let filtered = rests.filter(r => {
            const matchLoc = (locF === 'all' || r.loc === locF);
            const matchStyle = (styleF === 'all' || r.style === styleF);
            let matchTab = true;
            if(currentTab === 'wish') matchTab = (r.jane === 0);
            if(currentTab === 'high') matchTab = (r.jane >= 4);
            return matchLoc && matchStyle && matchTab;
        });

        container.innerHTML = filtered.map(r => `
            <div class="rest-item">
                <div class="rest-info">
                    <h4>${r.name} <small style="color:#ccc; font-weight:normal;">[${r.style}]</small></h4>
                    <p>ğŸ° ${r.jane} | ğŸ§” ${r.su || '?'} | ${r.loc}</p>
                    ${r.note ? `<p class="item-note">ğŸ“ ${r.note}</p>` : ''}
                </div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <button onclick="editRest(${r.id})" style="border:none; background:none; cursor:pointer; color:#ccc; font-size:1rem;">âœ</button>
                    <button onclick="deleteRest(${r.id})" style="border:none; background:none; cursor:pointer; color:#eee; font-size:1rem;">âœ•</button>
                </div>
            </div>
        `).reverse().join('');
    }

    function editRest(id) {
        const r = rests.find(i => i.id == id);
        if(!r) return;
        toggleForm(true);
        document.getElementById('edit-id').value = r.id;
        document.getElementById('restName').value = r.name;
        document.getElementById('restMap').value = r.map;
        document.getElementById('addLoc').value = r.loc;
        document.getElementById('addStyle').value = r.style;
        document.getElementById('janeScore').value = r.jane;
        document.getElementById('suScore').value = r.su;
        document.getElementById('restNote').value = r.note;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    async function deleteRest(id) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™é–“é¤å»³å—ï¼Ÿ')) {
            rests = rests.filter(r => r.id !== id);
            await saveToSupabase();
            renderRests();
        }
    }

    // ============================================================================
    // ğŸš« åé£Ÿå€ç®¡ç†
    // ============================================================================

    async function addPicky() {
        const val = document.getElementById('picky-input').value.trim();
        if(val) {
            picky.push(val);
            await saveToSupabase();
            document.getElementById('picky-input').value = '';
            renderPicky();
        }
    }

    function renderPicky() {
        document.getElementById('picky-tags').innerHTML = picky.map((p, i) => 
            `<span class="picky-tag" onclick="editPicky(${i})">${p}</span>`
        ).join('');
    }

    async function editPicky(i) {
        const n = prompt('ä¿®æ”¹å…§å®¹ (ç•™ç©ºå‰‡åˆªé™¤)ï¼š', picky[i]);
        if(n === null) return;
        if(n.trim() === "") {
            picky.splice(i, 1);
        } else {
            picky[i] = n;
        }
        await saveToSupabase();
        renderPicky();
    }

    // ============================================================================
    // ğŸ”„ æ•¸æ“šå‚™ä»½èˆ‡åŒ¯å…¥
    // ============================================================================

    function exportData() {
        const str = JSON.stringify({ r: rests, p: picky });
        navigator.clipboard.writeText(str).then(() => {
            alert('âœ… ä»£ç¢¼å·²è¤‡è£½ï¼å¯å‚³åˆ° LINE å‚™ä»½ã€‚');
        }).catch(() => {
            prompt("è«‹è¤‡è£½ä»¥ä¸‹æ–‡å­—ï¼š", str);
        });
    }

    async function importData() {
        const str = prompt('è«‹è²¼å…¥å‚™ä»½ä»£ç¢¼ï¼š');
        if(!str) return;
        try {
            const data = JSON.parse(str);
            if(data.r && Array.isArray(data.r)) {
                if(confirm('åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                    rests = data.r;
                    picky = data.p || [];
                    await saveToSupabase();
                    renderRests();
                    renderPicky();
                    alert('âœ… åŒ¯å…¥æˆåŠŸï¼');
                }
            }
        } catch(e) { alert('æ ¼å¼ä¸æ­£ç¢ºï¼'); }
    }

    // ============================================================================
    // ğŸ¨ UI æ§åˆ¶èˆ‡åˆ†é 
    // ============================================================================

    function setTab(tab, btn) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderRests();
    }

    function toggleForm(forceOpen) {
        const f = document.getElementById('add-form');
        if(forceOpen) f.classList.remove('hidden');
        else f.classList.toggle('hidden');
        if(f.classList.contains('hidden')) resetForm();
    }

    function resetForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('restName').value = '';
        document.getElementById('restMap').value = '';
        document.getElementById('restNote').value = '';
        document.getElementById('janeScore').value = 5;
        document.getElementById('suScore').value = 5;
    }

    // ============================================================================
    // ğŸ¤– AI æœå°‹ (éš¨æ©Ÿæ¨è–¦å¼•æ“)
    // ============================================================================

    function startGeminiSearch() {
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('ai-loading').classList.remove('hidden');
        document.getElementById('ai-result-content').classList.add('hidden');
        
        setTimeout(() => {
            // ç¯©é¸ï¼šæ’é™¤åé£Ÿæ¸…å–®ä¸­çš„é¤å»³
            const pool = rests.filter(r => !picky.some(p => r.name.includes(p)));
            const winner = pool.length > 0 ? pool[Math.floor(Math.random() * pool.length)] : rests[Math.floor(Math.random() * rests.length)];
            
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-result-content').classList.remove('hidden');
            
            if(winner) {
                document.getElementById('res-name').innerText = winner.name;
                document.getElementById('res-info').innerText = `${winner.loc} Â· ${winner.style}`;
                document.getElementById('res-score').innerText = `ğŸ° å’ª: ${winner.jane} | ğŸ§” è˜‡: ${winner.su}`;
                document.getElementById('res-note').innerText = winner.note || "é€™é–“é‚„æ²’å¯«ç­†è¨˜å–”ï¼";
                document.getElementById('res-map').href = winner.map || `https://www.google.com/maps/search/${encodeURIComponent(winner.name)}`;
            } else {
                document.getElementById('res-name').innerText = "åå–®ç©ºç©ºå¦‚ä¹Ÿ~";
            }
        }, 1200);
    }

    function closeOverlay() { document.getElementById('overlay').classList.add('hidden'); }
</script>

<!-- 
=== Supabase è¨­ç½®èªªæ˜ ===

è¦å•Ÿç”¨çœŸæ­£çš„é›²ç«¯å¤šè¨­å‚™åŒæ­¥ï¼Œè«‹æŒ‰ä»¥ä¸‹æ­¥é©Ÿï¼š

1. è¨ªå• https://supabase.com ä¸¦å…è²»è¨»å†Š
2. å»ºç«‹æ–°çš„ Supabase é …ç›®ï¼ˆé¸æ“‡ä»»æ„åœ°å€ï¼‰
3. ç­‰å¾…é …ç›®åˆå§‹åŒ–å®Œæˆ
4. åœ¨ Supabase Dashboard ä¸­ï¼š
   - å·¦å´èœå–® â†’ SQL Editor
   - æ–°å»ºä¸€å€‹ Query
   - è¤‡è£½ä¸¦åŸ·è¡Œä»¥ä¸‹ SQLï¼š

---
CREATE TABLE restaurant_data (
  id BIGSERIAL PRIMARY KEY,
  user_id TEXT NOT NULL,
  rests JSONB,
  picky JSONB,
  timestamp TIMESTAMP DEFAULT NOW(),
  device_info TEXT
);

-- è¨­ç½®å³æ™‚å»£æ’­æ¬Šé™
ALTER PUBLICATION supabase_realtime ADD TABLE restaurant_data;
---

5. å›åˆ° Settings â†’ API è¤‡è£½ï¼š
   - Project URL (ä¾‹å¦‚ https://xxxxx.supabase.co)
   - Anon Public Key

6. ç·¨è¼¯æœ¬æ–‡ä»¶ï¼Œæ‰¾åˆ°ç¬¬ 187-188 è¡Œï¼Œæ›¿æ›ï¼š
   var SUPABASE_URL = "ä½ çš„ Project URL";
   var SUPABASE_KEY = "ä½ çš„ Anon Public Key";

7. ä¿å­˜ä¸¦é‡æ–°è¼‰å…¥ç¶²é ï¼Œæ‡‰è©²çœ‹åˆ°ã€Œâœ“ é›²ç«¯å·²é€£æ¥ã€

ç¥ä½ åŒæ­¥æ„‰å¿«ï¼

-->

</body>
</html>
