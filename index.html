<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saki ç¾é£Ÿæ‰‹å¸³ | Foodie.AI</title>
    <style>
        /* CSS è¦–è¦ºå±¤ - æ—¥ç³»æ¥µç°¡ç¾å­¸ */
        @import url('https://fonts.googleapis.com/css2?family=Klee+One:wght@400;600&family=Noto+Serif+TC:wght@500;700&display=swap');

        :root {
            --bg-washi: #FDFCF8;
            --text-main: #4A3F35;
            --accent-blue: #7FB2BB;
            --border-color: #E6E2D8;
        }

        body { background: #F0F0F0; font-family: 'Noto Serif TC', serif; color: var(--text-main); margin: 0; }
        .app-container { width: 100%; max-width: 420px; margin: 0 auto; background: var(--bg-washi); min-height: 100vh; box-shadow: 0 0 20px rgba(0,0,0,0.05); }

        nav { padding: 30px 20px 20px; border-bottom: 1px solid var(--border-color); text-align: center; }
        .logo { font-size: 1.5rem; font-weight: 700; letter-spacing: 2px; }
        .subtitle { font-family: 'Klee One', cursive; font-size: 0.8rem; color: #999; margin-top: 5px; }

        .section-card { padding: 25px 20px; border-bottom: 1px solid var(--border-color); }
        .label { font-size: 0.85rem; font-weight: 700; margin-bottom: 15px; border-left: 3px solid var(--text-main); padding-left: 10px; }

        /* åˆ†é  Tabs */
        .tab-group { display: flex; gap: 15px; margin-bottom: 15px; border-bottom: 1px solid var(--border-color); }
        .tab-btn { background: none; border: none; padding: 8px 5px; font-family: inherit; color: #ccc; cursor: pointer; }
        .tab-btn.active { color: var(--text-main); font-weight: 700; border-bottom: 2px solid var(--text-main); }

        /* è¼¸å…¥èˆ‡è¡¨å–® */
        .filter-row { display: flex; gap: 8px; margin-bottom: 15px; }
        select, .input-field { width: 100%; padding: 12px; border: 1px solid var(--border-color); background: #fff; outline: none; font-family: inherit; box-sizing: border-box; }
        .input-row-flex { display: flex; gap: 8px; margin-bottom: 10px; }
        .rating-row { display: flex; justify-content: space-between; margin: 10px 0; font-size: 0.85rem; }
        .rating-row input { width: 45px; }
        .note-textarea { height: 70px; resize: none; margin-top: 5px; font-family: 'Klee One', cursive; }

        .btn-save { width: 100%; padding: 12px; background: var(--text-main); color: #fff; border: none; cursor: pointer; border-radius: 4px; }
        .btn-cancel { width: 100%; background: none; border: none; color: #aaa; margin-top: 8px; cursor: pointer; font-size: 0.8rem; }

        /* åˆ—è¡¨æ¨£å¼ */
        .rest-item { padding: 15px 0; border-bottom: 1px dotted var(--border-color); display: flex; justify-content: space-between; align-items: flex-start; }
        .rest-info h4 { margin: 0 0 5px; font-size: 1rem; }
        .rest-info p { margin: 0; font-size: 0.75rem; color: #888; }
        .item-note { font-family: 'Klee One', cursive; color: #666; font-size: 0.8rem; margin-top: 8px !important; }

        /* åé£Ÿæ¨™ç±¤ */
        .picky-tags { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .picky-tag { background: #eee; padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-family: 'Klee One', cursive; cursor: pointer; }

        /* æ¬å®¶å€ */
        .sync-area { background: #f9f9f9; border: 1px dashed #ddd; margin: 20px; padding: 15px; text-align: center; }
        .sync-btns { display: flex; gap: 10px; justify-content: center; margin-top: 10px; }
        .sync-btns button { font-size: 0.75rem; padding: 8px; cursor: pointer; border: 1px solid #ccc; background: #fff; }

        .hidden { display: none !important; }
        #overlay { position: fixed; inset: 0; background: rgba(74, 63, 53, 0.9); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: var(--bg-washi); width: 85%; max-width: 350px; padding: 30px; border-radius: 4px; text-align: center; }
        .spinner { border: 2px solid rgba(0,0,0,0.1); border-top: 2px solid var(--text-main); border-radius: 50%; width: 24px; height: 24px; animation: spin 0.8s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div class="app-container">
    <nav>
        <div class="logo">Foodie.AI</div>
        <div class="subtitle">Saki ç¾é£Ÿè³‡æ–™åº« / GitHub Pages</div>
    </nav>

    <main>
        <section class="section-card">
            <div class="label">âœ¨ Gemini æ™ºæ…§æœå°‹ / AI æ¤œç´¢</div>
            <div class="filter-row">
                <input type="text" id="ai-command" placeholder="æƒ³åƒé»ä»€éº¼ï¼Ÿ" class="input-field" style="flex:1">
                <button onclick="startGeminiSearch()" style="padding:0 15px; background:var(--text-main); color:white; border:none; border-radius:4px; cursor:pointer;">Ask</button>
            </div>
        </section>

        <section class="section-card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <div class="label" style="margin:0">ğŸ“¦ é¤å»³æ¸…å–® / ãƒªã‚¹ãƒˆ</div>
                <button onclick="toggleForm()" style="background:none; border:1px solid #ddd; padding:5px 10px; cursor:pointer; color:#888; border-radius:4px;">ï¼‹ æ–°å¢</button>
            </div>

            <div class="tab-group">
                <button class="tab-btn active" onclick="setTab('all', this)">å…¨éƒ¨</button>
                <button class="tab-btn" onclick="setTab('wish', this)">æƒ³å»æ¸…å–®</button>
                <button class="tab-btn" onclick="setTab('high', this)">é«˜åˆ† (4â˜…+)</button>
            </div>

            <div class="filter-row">
                <select id="loc-filter" onchange="renderRests()">
                    <option value="all">æ‰€æœ‰å€åŸŸ</option>
                    <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                    <option value="æ°‘é›„é„‰">æ°‘é›„é„‰</option>
                    <option value="ä¸­æ­£å¤§å­¸é™„è¿‘">ä¸­æ­£å¤§å­¸é™„è¿‘</option>
                </select>
                <select id="style-filter" onchange="renderRests()">
                    <option value="all">æ‰€æœ‰é¡åˆ¥</option>
                    <option value="ä¸­å¼">ä¸­å¼</option>
                    <option value="æ—¥å¼">æ—¥å¼</option>
                    <option value="éŸ“å¼">éŸ“å¼</option>
                    <option value="è¥¿å¼">è¥¿å¼</option>
                    <option value="ç”œé»/é£²æ–™">ç”œé»/é£²æ–™</option>
                </select>
            </div>

            <div id="add-form" class="hidden" style="background:#fff; padding:15px; border:1px solid var(--border-color); margin-bottom:20px; border-radius:4px;">
                <input type="hidden" id="edit-id">
                <input type="text" id="restName" placeholder="åº—å" class="input-field" style="margin-bottom:10px;">
                <input type="text" id="restMap" placeholder="Google Map é€£çµ" class="input-field" style="margin-bottom:10px;">
                <div class="input-row-flex">
                    <select id="addLoc" class="input-field">
                        <option value="å˜‰ç¾©å¸‚">å˜‰ç¾©å¸‚</option>
                        <option value="æ°‘é›„é„‰">æ°‘é›„é„‰</option>
                        <option value="ä¸­æ­£å¤§å­¸é™„è¿‘">ä¸­æ­£å¤§å­¸é™„è¿‘</option>
                    </select>
                    <select id="addStyle" class="input-field">
                        <option value="ä¸­å¼">ä¸­å¼</option>
                        <option value="æ—¥å¼">æ—¥å¼</option>
                        <option value="éŸ“å¼">éŸ“å¼</option>
                        <option value="è¥¿å¼">è¥¿å¼</option>
                        <option value="ç”œé»/é£²æ–™">ç”œé»/é£²æ–™</option>
                    </select>
                </div>
                <div class="rating-row">
                    <span>ğŸ° å’ª: <input type="number" id="janeScore" min="0" max="5" value="5"></span>
                    <span>ğŸ§” è˜‡: <input type="number" id="suScore" min="0" max="5" value="5"></span>
                </div>
                <textarea id="restNote" placeholder="å¿…é»èœè‰²æˆ–å¿ƒå¾—..." class="input-field note-textarea"></textarea>
                <button class="btn-save" onclick="saveRest()">ğŸ”’ é–å®šå­˜å…¥ / ä¿å­˜</button>
                <button class="btn-cancel" onclick="toggleForm()">å–æ¶ˆ</button>
            </div>

            <div id="rest-list"></div>
        </section>

        <section class="section-card">
            <div class="label">âœ Saki åé£Ÿæ‰‹å¸³ (é»æ“Šå¯ç·¨è¼¯)</div>
            <div class="filter-row">
                <input type="text" id="picky-input" placeholder="æˆ‘ä¸åƒ..." class="input-field" style="flex:1">
                <button onclick="addPicky()" style="padding:0 15px; background:none; border:1px solid #ddd; cursor:pointer; border-radius:4px;">ç´€éŒ„</button>
            </div>
            <div id="picky-tags" class="picky-tags"></div>
        </section>

        <div class="sync-area">
            <div style="font-size:0.8rem; font-weight:bold; color:#666;">ğŸ”„ è¨­å‚™åŒæ­¥ (é›»è…¦ â†” æ‰‹æ©Ÿ)</div>
            <div class="sync-btns">
                <button onclick="exportData()">1. è¤‡è£½å‚™ä»½ä»£ç¢¼</button>
                <button onclick="importData()">2. åŒ¯å…¥ä»£ç¢¼</button>
            </div>
        </div>
    </main>

    <div id="overlay" class="hidden" onclick="closeOverlay()">
        <div class="modal" onclick="event.stopPropagation()">
            <div id="ai-loading"><div class="spinner"></div><p>Gemini åˆ†æä¸­...</p></div>
            <div id="ai-result-content" class="hidden">
                <h2 id="res-name"></h2>
                <div id="res-info" style="margin:10px 0; font-size:0.9rem; color:#888;"></div>
                <div id="res-score" style="margin:10px 0; color:var(--accent-blue); font-weight:bold;"></div>
                <p id="res-note" style="font-family:'Klee One'; color:#666; font-size:0.9rem;"></p>
                <a id="res-map" href="#" target="_blank" style="display:block; margin:20px 0; padding:12px; background:var(--accent-blue); color:white; text-decoration:none; border-radius:4px; font-weight:bold;">ğŸ“ é–‹å•Ÿåœ°åœ–å°èˆª</a>
                <button onclick="closeOverlay()" style="border:none; background:none; color:#999; cursor:pointer; font-size:0.8rem;">é—œé–‰ / Close</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- è³‡æ–™æ ¸å¿ƒ ---
    const DB_KEY = 'SAKI_STORAGE_V4';
    const PICKY_KEY = 'SAKI_PICKY_V4';

    let rests = JSON.parse(localStorage.getItem(DB_KEY)) || [];
    let picky = JSON.parse(localStorage.getItem(PICKY_KEY)) || [];
    let currentTab = 'all';

    document.addEventListener('DOMContentLoaded', () => { 
        renderRests(); 
        renderPicky();
        startAutoSync();
    });

    // è‡ªå‹•åŒæ­¥ - æ¯ 2 ç§’æª¢æŸ¥ä¸€æ¬¡æœ¬åœ°å­˜å„²ï¼Œè‹¥æœ‰è®ŠåŒ–å‰‡æ›´æ–°
    function startAutoSync() {
        setInterval(() => {
            const storedRests = localStorage.getItem(DB_KEY);
            const storedPicky = localStorage.getItem(PICKY_KEY);
            
            if(storedRests) {
                const newRests = JSON.parse(storedRests);
                if(JSON.stringify(newRests) !== JSON.stringify(rests)) {
                    rests = newRests;
                    renderRests();
                }
            }
            
            if(storedPicky) {
                const newPicky = JSON.parse(storedPicky);
                if(JSON.stringify(newPicky) !== JSON.stringify(picky)) {
                    picky = newPicky;
                    renderPicky();
                }
            }
        }, 2000);
    }

    // --- åˆ†é èˆ‡ç¯©é¸ ---
    function setTab(tab, btn) {
        currentTab = tab;
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderRests();
    }

    // --- é¤å»³ç®¡ç† (å¢åˆªæ”¹) ---
    function saveRest() {
        const id = document.getElementById('edit-id').value;
        const name = document.getElementById('restName').value;
        if(!name) return alert('åº—åæ˜¯å¿…å¡«çš„å–”ï¼');

        const newRest = {
            id: id ? parseInt(id) : Date.now(),
            name: name,
            map: document.getElementById('restMap').value,
            loc: document.getElementById('addLoc').value,
            style: document.getElementById('addStyle').value,
            jane: document.getElementById('janeScore').value,
            su: document.getElementById('suScore').value,
            note: document.getElementById('restNote').value
        };

        if(id) {
            const idx = rests.findIndex(r => r.id == id);
            rests[idx] = newRest;
        } else {
            rests.push(newRest);
        }
        
        saveAndRefresh();
        toggleForm();
    }

    function renderRests() {
        const locF = document.getElementById('loc-filter').value;
        const styleF = document.getElementById('style-filter').value;
        const container = document.getElementById('rest-list');

        let filtered = rests.filter(r => {
            const matchLoc = (locF === 'all' || r.loc === locF);
            const matchStyle = (styleF === 'all' || r.style === styleF);
            let matchTab = true;
            if(currentTab === 'wish') matchTab = (parseInt(r.jane) === 0);
            if(currentTab === 'high') matchTab = (parseInt(r.jane) >= 4);
            return matchLoc && matchStyle && matchTab;
        });

        container.innerHTML = filtered.map(r => `
            <div class="rest-item">
                <div class="rest-info">
                    <h4>${r.name} <small style="color:#ccc; font-weight:normal;">[${r.style}]</small></h4>
                    <p>ğŸ° ${r.jane} | ğŸ§” ${r.su || '?'} | ${r.loc}</p>
                    ${r.note ? `<p class="item-note">ğŸ“ ${r.note}</p>` : ''}
                </div>
                <div style="display:flex; gap:12px; align-items:center;">
                    <button onclick="editRest(${r.id})" style="border:none; background:none; cursor:pointer; color:#ccc; font-size:1rem;">âœ</button>
                    <button onclick="deleteRest(${r.id})" style="border:none; background:none; cursor:pointer; color:#eee; font-size:1rem;">âœ•</button>
                </div>
            </div>
        `).reverse().join('');
    }

    function editRest(id) {
        const r = rests.find(i => i.id == id);
        toggleForm(true);
        document.getElementById('edit-id').value = r.id;
        document.getElementById('restName').value = r.name;
        document.getElementById('restMap').value = r.map;
        document.getElementById('addLoc').value = r.loc;
        document.getElementById('addStyle').value = r.style;
        document.getElementById('janeScore').value = r.jane;
        document.getElementById('suScore').value = r.su;
        document.getElementById('restNote').value = r.note;
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteRest(id) {
        if(confirm('ç¢ºå®šè¦åˆªé™¤é€™é–“é¤å»³å—ï¼Ÿ')) {
            rests = rests.filter(r => r.id !== id);
            saveAndRefresh();
        }
    }

    // --- åé£Ÿå€ç®¡ç† ---
    function addPicky() {
        const val = document.getElementById('picky-input').value.trim();
        if(val) {
            picky.push(val);
            localStorage.setItem(PICKY_KEY, JSON.stringify(picky));
            document.getElementById('picky-input').value = '';
            renderPicky();
        }
    }

    function renderPicky() {
        document.getElementById('picky-tags').innerHTML = picky.map((p, i) => 
            `<span class="picky-tag" onclick="editPicky(${i})">${p}</span>`
        ).join('');
    }

    function editPicky(i) {
        const n = prompt('ä¿®æ”¹å…§å®¹ (ç•™ç©ºå‰‡åˆªé™¤)ï¼š', picky[i]);
        if(n === null) return;
        if(n.trim() === "") picky.splice(i, 1); else picky[i] = n;
        localStorage.setItem(PICKY_KEY, JSON.stringify(picky));
        renderPicky();
    }

    // --- åŒæ­¥æ¬å®¶ ---
    function exportData() {
        const str = JSON.stringify({ r: rests, p: picky });
        navigator.clipboard.writeText(str).then(() => {
            alert('âœ… ä»£ç¢¼å·²è¤‡è£½ï¼è«‹å‚³åˆ° LINEï¼Œå†åˆ°æ‰‹æ©Ÿä¸ŠæŒ‰ã€ŒåŒ¯å…¥ä»£ç¢¼ã€ã€‚');
        }).catch(() => {
            prompt("è«‹è¤‡è£½ä»¥ä¸‹æ–‡å­—ï¼š", str);
        });
    }

    function importData() {
        const str = prompt('è«‹è²¼å…¥å‚™ä»½ä»£ç¢¼ï¼š');
        if(!str) return;
        try {
            const data = JSON.parse(str);
            if(data.r) {
                if(confirm('åŒ¯å…¥å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼Œç¢ºå®šå—ï¼Ÿ')) {
                    rests = data.r; picky = data.p || [];
                    saveAndRefresh();
                    location.reload();
                }
            }
        } catch(e) { alert('æ ¼å¼ä¸æ­£ç¢ºï¼'); }
    }

    // --- UI æ§åˆ¶ ---
    function toggleForm(forceOpen) {
        const f = document.getElementById('add-form');
        if(forceOpen) f.classList.remove('hidden');
        else f.classList.toggle('hidden');
        if(f.classList.contains('hidden')) resetForm();
    }

    function resetForm() {
        document.getElementById('edit-id').value = '';
        document.getElementById('restName').value = '';
        document.getElementById('restMap').value = '';
        document.getElementById('restNote').value = '';
    }

    function saveAndRefresh() {
        localStorage.setItem(DB_KEY, JSON.stringify(rests));
        renderRests();
    }

    function startGeminiSearch() {
        document.getElementById('overlay').classList.remove('hidden');
        document.getElementById('ai-loading').classList.remove('hidden');
        document.getElementById('ai-result-content').classList.add('hidden');
        
        setTimeout(() => {
            // éæ¿¾æ‰åŒ…å«åé£Ÿæ¨™ç±¤çš„é¤å»³
            const pool = rests.filter(r => !picky.some(p => r.name.includes(p)));
            const winner = pool.length > 0 ? pool[Math.floor(Math.random() * pool.length)] : rests[Math.floor(Math.random() * rests.length)];
            
            document.getElementById('ai-loading').classList.add('hidden');
            document.getElementById('ai-result-content').classList.remove('hidden');
            
            if(winner) {
                document.getElementById('res-name').innerText = winner.name;
                document.getElementById('res-info').innerText = `${winner.loc} Â· ${winner.style}`;
                document.getElementById('res-score').innerText = `ğŸ° å’ª: ${winner.jane} | ğŸ§” è˜‡: ${winner.su}`;
                document.getElementById('res-note').innerText = winner.note || "é€™é–“é‚„æ²’å¯«ç­†è¨˜å–”ï¼";
                document.getElementById('res-map').href = winner.map || `https://www.google.com/maps/search/${encodeURIComponent(winner.name)}`;
            } else {
                document.getElementById('res-name').innerText = "åå–®ç©ºç©ºå¦‚ä¹Ÿ~";
            }
        }, 1200);
    }

    function closeOverlay() { document.getElementById('overlay').classList.add('hidden'); }
</script>

</body>
</html>
